{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport Resource from './resource';\nimport { FEATURES, hasFeatures } from '../features';\nimport { isWebGL2 } from '../webgl-utils';\nimport { assert } from '../utils';\nvar GL_QUERY_RESULT = 0x8866;\nvar GL_QUERY_RESULT_AVAILABLE = 0x8867;\nvar GL_TIME_ELAPSED_EXT = 0x88bf;\nvar GL_GPU_DISJOINT_EXT = 0x8fbb;\nvar GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN = 0x8c88;\nvar GL_ANY_SAMPLES_PASSED = 0x8c2f;\nvar GL_ANY_SAMPLES_PASSED_CONSERVATIVE = 0x8d6a;\n\nvar Query = function (_Resource) {\n  _inherits(Query, _Resource);\n\n  _createClass(Query, null, [{\n    key: \"isSupported\",\n    value: function isSupported(gl) {\n      var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];\n      var webgl2 = isWebGL2(gl);\n      var hasTimerQuery = hasFeatures(gl, FEATURES.TIMER_QUERY);\n      var supported = webgl2 || hasTimerQuery;\n      var _iteratorNormalCompletion = true;\n      var _didIteratorError = false;\n      var _iteratorError = undefined;\n\n      try {\n        for (var _iterator = opts[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n          var key = _step.value;\n\n          switch (key) {\n            case 'queries':\n              supported = supported && webgl2;\n              break;\n\n            case 'timers':\n              supported = supported && hasTimerQuery;\n              break;\n\n            default:\n              assert(false);\n          }\n        }\n      } catch (err) {\n        _didIteratorError = true;\n        _iteratorError = err;\n      } finally {\n        try {\n          if (!_iteratorNormalCompletion && _iterator[\"return\"] != null) {\n            _iterator[\"return\"]();\n          }\n        } finally {\n          if (_didIteratorError) {\n            throw _iteratorError;\n          }\n        }\n      }\n\n      return supported;\n    }\n  }]);\n\n  function Query(gl) {\n    var _this;\n\n    var opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    _classCallCheck(this, Query);\n\n    _this = _possibleConstructorReturn(this, _getPrototypeOf(Query).call(this, gl, opts));\n    _this.target = null;\n    _this._queryPending = false;\n    _this._pollingPromise = null;\n    Object.seal(_assertThisInitialized(_this));\n    return _this;\n  }\n\n  _createClass(Query, [{\n    key: \"beginTimeElapsedQuery\",\n    value: function beginTimeElapsedQuery() {\n      return this.begin(GL_TIME_ELAPSED_EXT);\n    }\n  }, {\n    key: \"beginOcclusionQuery\",\n    value: function beginOcclusionQuery() {\n      var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n          _ref$conservative = _ref.conservative,\n          conservative = _ref$conservative === void 0 ? false : _ref$conservative;\n\n      return this.begin(conservative ? GL_ANY_SAMPLES_PASSED_CONSERVATIVE : GL_ANY_SAMPLES_PASSED);\n    }\n  }, {\n    key: \"beginTransformFeedbackQuery\",\n    value: function beginTransformFeedbackQuery() {\n      return this.begin(GL_TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN);\n    }\n  }, {\n    key: \"begin\",\n    value: function begin(target) {\n      if (this._queryPending) {\n        return this;\n      }\n\n      this.target = target;\n      this.gl.beginQuery(this.target, this.handle);\n      return this;\n    }\n  }, {\n    key: \"end\",\n    value: function end() {\n      if (this._queryPending) {\n        return this;\n      }\n\n      if (this.target) {\n        this.gl.endQuery(this.target);\n        this.target = null;\n        this._queryPending = true;\n      }\n\n      return this;\n    }\n  }, {\n    key: \"isResultAvailable\",\n    value: function isResultAvailable() {\n      if (!this._queryPending) {\n        return false;\n      }\n\n      var resultAvailable = this.gl.getQueryParameter(this.handle, GL_QUERY_RESULT_AVAILABLE);\n\n      if (resultAvailable) {\n        this._queryPending = false;\n      }\n\n      return resultAvailable;\n    }\n  }, {\n    key: \"isTimerDisjoint\",\n    value: function isTimerDisjoint() {\n      return this.gl.getParameter(GL_GPU_DISJOINT_EXT);\n    }\n  }, {\n    key: \"getResult\",\n    value: function getResult() {\n      return this.gl.getQueryParameter(this.handle, GL_QUERY_RESULT);\n    }\n  }, {\n    key: \"getTimerMilliseconds\",\n    value: function getTimerMilliseconds() {\n      return this.getResult() / 1e6;\n    }\n  }, {\n    key: \"createPoll\",\n    value: function createPoll() {\n      var _this2 = this;\n\n      var limit = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Number.POSITIVE_INFINITY;\n\n      if (this._pollingPromise) {\n        return this._pollingPromise;\n      }\n\n      var counter = 0;\n      this._pollingPromise = new Promise(function (resolve, reject) {\n        var poll = function poll() {\n          if (_this2.isResultAvailable()) {\n            resolve(_this2.getResult());\n            _this2._pollingPromise = null;\n          } else if (counter++ > limit) {\n            reject('Timed out');\n            _this2._pollingPromise = null;\n          } else {\n            requestAnimationFrame(poll);\n          }\n        };\n\n        requestAnimationFrame(poll);\n      });\n      return this._pollingPromise;\n    }\n  }, {\n    key: \"_createHandle\",\n    value: function _createHandle() {\n      return Query.isSupported(this.gl) ? this.gl.createQuery() : null;\n    }\n  }, {\n    key: \"_deleteHandle\",\n    value: function _deleteHandle() {\n      this.gl.deleteQuery(this.handle);\n    }\n  }]);\n\n  return Query;\n}(Resource);\n\nexport { Query as default };","map":null,"metadata":{},"sourceType":"module"}
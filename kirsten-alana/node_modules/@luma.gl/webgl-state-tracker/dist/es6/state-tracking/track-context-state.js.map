{"version":3,"sources":["../../../src/state-tracking/track-context-state.js"],"names":["GL_STATE_SETTERS","GL_PARAMETER_DEFAULTS","setParameters","getParameters","assert","clone","x","Array","isArray","ArrayBuffer","isView","slice","deepEqual","y","isArrayX","isArrayY","length","i","installGetterOverride","gl","functionName","originalGetterFunc","bind","get","pname","state","cache","enable","Object","defineProperty","value","configurable","installSetterSpy","setter","originalSetterFunc","set","params","_updateCache","valueChanged","oldValue","log","GLState","constructor","copyState","stateStack","assign","seal","push","values","pop","oldValues","key","undefined","trackContextState","global_","global","window","polyfillContext","pushContextState","popContextState"],"mappings":"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","sourcesContent":["// Support for listening to context state changes and intercepting state queries\n//\n// NOTE: this system does not handle buffer bindings\nimport GL_STATE_SETTERS from './webgl-function-to-parameters-table';\nimport {GL_PARAMETER_DEFAULTS} from '../unified-parameter-api/webgl-parameter-tables';\nimport {setParameters, getParameters} from '../unified-parameter-api/unified-parameter-api';\nimport {assert} from '../utils';\n\nexport const clone = x => {\n  return Array.isArray(x) || ArrayBuffer.isView(x) ? x.slice() : x;\n};\n\nexport const deepEqual = (x, y) => {\n  const isArrayX = Array.isArray(x) || ArrayBuffer.isView(x);\n  const isArrayY = Array.isArray(y) || ArrayBuffer.isView(y);\n  if (isArrayX && isArrayY && x.length === y.length) {\n    for (let i = 0; i < x.length; ++i) {\n      if (x[i] !== y[i]) {\n        return false;\n      }\n    }\n    return true;\n  }\n  return x === y;\n};\n\n// HELPER FUNCTIONS - INSTALL GET/SET INTERCEPTORS (SPYS) ON THE CONTEXT\n\n// Overrides a WebGLRenderingContext state \"getter\" function\n// to return values directly from cache\nfunction installGetterOverride(gl, functionName) {\n  // Get the original function from the WebGLRenderingContext\n  const originalGetterFunc = gl[functionName].bind(gl);\n\n  // Wrap it with a spy so that we can update our state cache when it gets called\n  gl[functionName] = function get(...params) {\n    const pname = params[0];\n\n    // WebGL limits are not prepopulated in the cache, we must\n    // query first time. They are all primitive (single value)\n    if (!(pname in gl.state.cache)) {\n      gl.state.cache[pname] = originalGetterFunc(...params);\n    }\n\n    // Optionally call the original function to do a \"hard\" query from the WebGLRenderingContext\n    return gl.state.enable\n      ? // Call the getter the params so that it can e.g. serve from a cache\n        gl.state.cache[pname]\n      : // Optionally call the original function to do a \"hard\" query from the WebGLRenderingContext\n        originalGetterFunc(...params);\n  };\n\n  // Set the name of this anonymous function to help in debugging and profiling\n  Object.defineProperty(gl[functionName], 'name', {\n    value: `${functionName}-from-cache`,\n    configurable: false\n  });\n}\n\n// Overrides a WebGLRenderingContext state \"setter\" function\n// to call a setter spy before the actual setter. Allows us to keep a cache\n// updated with a copy of the WebGL context state.\nfunction installSetterSpy(gl, functionName, setter) {\n  // Get the original function from the WebGLRenderingContext\n  const originalSetterFunc = gl[functionName].bind(gl);\n\n  // Wrap it with a spy so that we can update our state cache when it gets called\n  gl[functionName] = function set(...params) {\n    // Update the value\n    // Call the setter with the state cache and the params so that it can store the parameters\n    const {valueChanged, oldValue} = setter(gl.state._updateCache, ...params);\n\n    // Call the original WebGLRenderingContext func to make sure the context actually gets updated\n    if (valueChanged) {\n      gl.state.log(`gl.${functionName}`, ...params); // eslint-disable-line\n      originalSetterFunc(...params);\n    }\n\n    // Note: if the original function fails to set the value, our state cache will be bad\n    // No solution for this at the moment, but assuming that this is unlikely to be a real problem\n    // We could call the setter after the originalSetterFunc. Concern is that this would\n    // cause different behavior in debug mode, where originalSetterFunc can throw exceptions\n\n    return oldValue;\n  };\n\n  // Set the name of this anonymous function to help in debugging and profiling\n  Object.defineProperty(gl[functionName], 'name', {\n    value: `${functionName}-to-cache`,\n    configurable: false\n  });\n}\n\n// HELPER CLASS - GLState\n\n/* eslint-disable no-shadow */\nclass GLState {\n  constructor(\n    gl,\n    {\n      copyState = false, // Copy cache from params (slow) or initialize from WebGL defaults (fast)\n      log = () => {} // Logging function, called when gl parameter change calls are actually issued\n    } = {}\n  ) {\n    this.gl = gl;\n    this.stateStack = [];\n    this.enable = true;\n    this.cache = copyState ? getParameters(gl) : Object.assign({}, GL_PARAMETER_DEFAULTS);\n    this.log = log;\n\n    this._updateCache = this._updateCache.bind(this);\n    Object.seal(this);\n  }\n\n  push(values = {}) {\n    this.stateStack.push({});\n  }\n\n  pop() {\n    assert(this.stateStack.length > 0);\n    // Use the saved values in the state stack to restore parameters\n    const oldValues = this.stateStack[this.stateStack.length - 1];\n    setParameters(this.gl, oldValues, this.cache);\n    // Don't pop until we have reset parameters (to make sure other \"stack frames\" are not affected)\n    this.stateStack.pop();\n  }\n\n  // interceptor for context set functions - update our cache and our stack\n  // values (Object) - the key values for this setter\n  _updateCache(values) {\n    let valueChanged = false;\n    let oldValue; // = undefined\n\n    const oldValues = this.stateStack.length > 0 && this.stateStack[this.stateStack.length - 1];\n\n    for (const key in values) {\n      assert(key !== undefined);\n      // Check that value hasn't already been shadowed\n      if (!deepEqual(values[key], this.cache[key])) {\n        valueChanged = true;\n        oldValue = this.cache[key];\n\n        // First, save current value being shadowed\n        // If a state stack frame is active, save the current parameter values for pop\n        // but first check that value hasn't already been shadowed and saved\n        if (oldValues && !(key in oldValues)) {\n          oldValues[key] = this.cache[key];\n        }\n\n        // Save current value being shadowed\n        this.cache[key] = values[key];\n      }\n    }\n\n    return {valueChanged, oldValue};\n  }\n}\n\n// PUBLIC API\n\n/**\n * Initialize WebGL state caching on a context\n * can be called multiple times to enable/disable\n * @param {WebGLRenderingContext} - context\n */\n// After calling this function, context state will be cached\n// gl.state.push() and gl.state.pop() will be available for saving,\n// temporarily modifying, and then restoring state.\nexport default function trackContextState(gl, {enable = true, copyState} = {}) {\n  assert(copyState !== undefined);\n  if (!gl.state) {\n    /* global window, global */\n    const global_ = typeof global !== 'undefined' ? global : window;\n    if (global_.polyfillContext) {\n      global_.polyfillContext(gl);\n    }\n\n    // Create a state cache\n    gl.state = new GLState(gl, {copyState, enable});\n\n    // intercept all setter functions in the table\n    for (const key in GL_STATE_SETTERS) {\n      const setter = GL_STATE_SETTERS[key];\n      installSetterSpy(gl, key, setter);\n    }\n\n    // intercept all getter functions in the table\n    installGetterOverride(gl, 'getParameter');\n    installGetterOverride(gl, 'isEnabled');\n  }\n\n  gl.state.enable = enable;\n\n  return gl;\n}\n\nexport function pushContextState(gl) {\n  if (!gl.state) {\n    trackContextState(gl, {copyState: false});\n  }\n  gl.state.push();\n}\n\nexport function popContextState(gl) {\n  assert(gl.state);\n  gl.state.pop();\n}\n"],"file":"track-context-state.js"}
{"version":3,"sources":["../../../src/gpu-grid-layer/gpu-grid-cell-layer.js"],"names":["Layer","Model","CubeGeometry","fp64","PhongMaterial","fp64LowPart","defaultMaterial","vs","fs","DEFAULT_MINCOLOR","DEFAULT_MAXCOLOR","AGGREGATION_DATA_UBO_INDEX","defaultProps","cellSize","type","min","max","value","coverage","elevationScale","extruded","pickable","minColor","maxColor","material","GPUGridCellLayer","getShaders","modules","initializeState","attributeManager","getAttributeManager","addInstanced","instanceCounts","size","update","calculateInstanceCounts","noAlloc","updateState","props","oldProps","changeFlags","gl","context","state","model","delete","_getModel","_setupUniformBuffer","setState","invalidate","countsBuffer","Object","assign","id","geometry","isInstanced","shaderCache","draw","uniforms","gridSize","gridOrigin","gridOffset","maxCountBuffer","gridOriginLow","gridOffsetLow","bind","target","index","setUniforms","unbind","attribute","buffer","programHandle","program","handle","uniformBlockIndex","getUniformBlockIndex","uniformBlockBinding","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer} from '@deck.gl/core';\nimport GL from '@luma.gl/constants';\nimport {Model, CubeGeometry, fp64, PhongMaterial} from '@luma.gl/core';\nconst {fp64LowPart} = fp64;\nconst defaultMaterial = new PhongMaterial();\n\nimport vs from './gpu-grid-cell-layer-vertex.glsl';\nimport fs from './gpu-grid-cell-layer-fragment.glsl';\n\nconst DEFAULT_MINCOLOR = [0, 0, 0, 255];\nconst DEFAULT_MAXCOLOR = [0, 255, 0, 255];\nconst AGGREGATION_DATA_UBO_INDEX = 0;\n\nconst defaultProps = {\n  cellSize: {type: 'number', min: 0, max: 1000, value: 1000},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  elevationScale: {type: 'number', min: 0, value: 1},\n  extruded: true,\n  fp64: false,\n  pickable: false, // TODO: add picking support (read from aggregated texture)\n\n  minColor: {type: 'color', value: DEFAULT_MINCOLOR},\n  maxColor: {type: 'color', value: DEFAULT_MAXCOLOR},\n\n  material: defaultMaterial\n};\n\nexport default class GPUGridCellLayer extends Layer {\n  getShaders() {\n    return {vs, fs, modules: ['project32', 'gouraud-lighting', 'picking', 'fp64']};\n  }\n\n  initializeState() {\n    const attributeManager = this.getAttributeManager();\n    attributeManager.addInstanced({\n      instanceCounts: {\n        size: 4,\n        update: this.calculateInstanceCounts,\n        noAlloc: true\n      }\n    });\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    super.updateState({props, oldProps, changeFlags});\n    // Re-generate model if geometry changed\n    if (props.fp64 !== oldProps.fp64) {\n      const {gl} = this.context;\n      if (this.state.model) {\n        this.state.model.delete();\n      }\n      const model = this._getModel(gl);\n      this._setupUniformBuffer(model);\n      this.setState({model});\n      this.state.attributeManager.invalidate('instanceCounts');\n    }\n    if (props.countsBuffer !== oldProps.countsBuffer) {\n      this.state.attributeManager.invalidate('instanceCounts');\n    }\n  }\n\n  _getModel(gl) {\n    return new Model(\n      gl,\n      Object.assign({}, this.getShaders(), {\n        id: this.props.id,\n        geometry: new CubeGeometry(),\n        isInstanced: true,\n        shaderCache: this.context.shaderCache\n      })\n    );\n  }\n\n  draw({uniforms}) {\n    const {\n      cellSize,\n      extruded,\n      elevationScale,\n      coverage,\n      gridSize,\n      gridOrigin,\n      gridOffset,\n      minColor,\n      maxColor,\n      maxCountBuffer\n    } = this.props;\n\n    const gridOriginLow = [fp64LowPart(gridOrigin[0]), fp64LowPart(gridOrigin[1])];\n    const gridOffsetLow = [fp64LowPart(gridOffset[0]), fp64LowPart(gridOffset[1])];\n\n    maxCountBuffer.bind({target: GL.UNIFORM_BUFFER, index: AGGREGATION_DATA_UBO_INDEX});\n    this.state.model\n      .setUniforms(\n        Object.assign({}, uniforms, {\n          cellSize,\n          extruded,\n          elevationScale,\n          coverage,\n          gridSize,\n          gridOrigin,\n          gridOriginLow,\n          gridOffset,\n          gridOffsetLow,\n          minColor,\n          maxColor\n        })\n      )\n      .draw();\n    maxCountBuffer.unbind({target: GL.UNIFORM_BUFFER, index: AGGREGATION_DATA_UBO_INDEX});\n  }\n\n  calculateInstanceCounts(attribute) {\n    const {countsBuffer} = this.props;\n    attribute.update({\n      buffer: countsBuffer\n    });\n  }\n\n  _setupUniformBuffer(model) {\n    const gl = this.context.gl;\n    const programHandle = model.program.handle;\n\n    const uniformBlockIndex = gl.getUniformBlockIndex(programHandle, 'AggregationData');\n    gl.uniformBlockBinding(programHandle, uniformBlockIndex, AGGREGATION_DATA_UBO_INDEX);\n  }\n}\n\nGPUGridCellLayer.layerName = 'GPUGridCellLayer';\nGPUGridCellLayer.defaultProps = defaultProps;\n"],"file":"gpu-grid-cell-layer.js"}
{"version":3,"sources":["../../../src/lib/parse-with-worker.js"],"names":["workerCache","Map","getWorker","workerSource","workerURL","get","blob","Blob","type","URL","createObjectURL","set","Worker","parseWithWorker","data","options","worker","removeNontransferableOptions","parse","rawData","opts","Promise","resolve","reject","onmessage","evt","result","terminate","Error","message","arraybuffer","postMessage","Object","assign","log"],"mappings":";;;;;;;AAAA;;AAEA,IAAMA,WAAW,GAAG,IAAIC,GAAJ,EAApB;;AAGA,SAASC,SAAT,CAAmBC,YAAnB,EAAiC;AAC/B,MAAIC,SAAS,GAAGJ,WAAW,CAACK,GAAZ,CAAgBF,YAAhB,CAAhB;;AACA,MAAI,CAACC,SAAL,EAAgB;AACd,QAAME,IAAI,GAAG,IAAIC,IAAJ,CAAS,CAACJ,YAAD,CAAT,EAAyB;AAACK,MAAAA,IAAI,EAAE;AAAP,KAAzB,CAAb;AACAJ,IAAAA,SAAS,GAAGK,GAAG,CAACC,eAAJ,CAAoBJ,IAApB,CAAZ;AACAN,IAAAA,WAAW,CAACW,GAAZ,CAAgBR,YAAhB,EAA8BC,SAA9B;AACD;;AACD,SAAO,IAAIQ,MAAJ,CAAWR,SAAX,CAAP;AACD;;AAEc,SAASS,eAAT,CAAyBV,YAAzB,EAAuCW,IAAvC,EAA6CC,OAA7C,EAAsD;AACnE,MAAMC,MAAM,GAAGd,SAAS,CAACC,YAAD,CAAxB;AAEAY,EAAAA,OAAO,GAAGE,4BAA4B,CAACF,OAAD,CAAtC;;AAEA,MAAMG,KAAK,GAAG,SAARA,KAAQ,CAACC,OAAD,EAAUC,IAAV;AAAA,WACZ,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AAC/BP,MAAAA,MAAM,CAACQ,SAAP,GAAmB,UAAAC,GAAG,EAAI;AACxB,gBAAQA,GAAG,CAACX,IAAJ,CAASN,IAAjB;AACE,eAAK,MAAL;AACEc,YAAAA,OAAO,CAACG,GAAG,CAACX,IAAJ,CAASY,MAAV,CAAP;AACAV,YAAAA,MAAM,CAACW,SAAP;AACA;;AAEF,eAAK,OAAL;AACEJ,YAAAA,MAAM,CAAC,IAAIK,KAAJ,CAAUH,GAAG,CAACX,IAAJ,CAASe,OAAnB,CAAD,CAAN;AACA;;AAEF;AAVF;AAYD,OAbD;;AAeA,UAAMC,WAAW,GAAG,gCAAcX,OAAd,CAApB;AACAH,MAAAA,MAAM,CAACe,WAAP,CAAmB;AAACD,QAAAA,WAAW,EAAXA,WAAD;AAAcV,QAAAA,IAAI,EAAJA;AAAd,OAAnB,EAAwC,CAACU,WAAD,CAAxC;AACD,KAlBD,CADY;AAAA,GAAd;;AAqBA,SAAOhB,IAAI,GAAGI,KAAK,CAACJ,IAAD,EAAOC,OAAP,CAAR,GAA0BG,KAArC;AACD;;AAED,SAASD,4BAAT,CAAsCF,OAAtC,EAA+C;AAC7CA,EAAAA,OAAO,GAAGiB,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBlB,OAAlB,CAAV;;AAGA,MAAIA,OAAO,CAACmB,GAAR,KAAgB,IAApB,EAA0B;AACxB,WAAOnB,OAAO,CAACmB,GAAf;AACD;;AACD,SAAOnB,OAAP;AACD","sourcesContent":["import {toArrayBuffer} from '../javascript-utils/binary-utils';\n\nconst workerCache = new Map();\n\n/* global Worker, Blob, URL */\nfunction getWorker(workerSource) {\n  let workerURL = workerCache.get(workerSource);\n  if (!workerURL) {\n    const blob = new Blob([workerSource], {type: 'application/javascript'});\n    workerURL = URL.createObjectURL(blob);\n    workerCache.set(workerSource, workerURL);\n  }\n  return new Worker(workerURL);\n}\n\nexport default function parseWithWorker(workerSource, data, options) {\n  const worker = getWorker(workerSource);\n\n  options = removeNontransferableOptions(options);\n\n  const parse = (rawData, opts) =>\n    new Promise((resolve, reject) => {\n      worker.onmessage = evt => {\n        switch (evt.data.type) {\n          case 'done':\n            resolve(evt.data.result);\n            worker.terminate();\n            break;\n\n          case 'error':\n            reject(new Error(evt.data.message));\n            break;\n\n          default:\n        }\n      };\n\n      const arraybuffer = toArrayBuffer(rawData);\n      worker.postMessage({arraybuffer, opts}, [arraybuffer]);\n    });\n\n  return data ? parse(data, options) : parse;\n}\n\nfunction removeNontransferableOptions(options) {\n  options = Object.assign({}, options);\n  // log object contains functions which cannot be transferred\n  // TODO - decide how to handle logging on workers\n  if (options.log !== null) {\n    delete options.log;\n  }\n  return options;\n}\n"],"file":"parse-with-worker.js"}
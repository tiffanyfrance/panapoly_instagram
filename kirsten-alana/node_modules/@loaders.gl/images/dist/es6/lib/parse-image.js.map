{"version":3,"sources":["../../../src/lib/parse-image.js"],"names":["parseImageNode","canParseImage","ImageBitmap","parseImage","arrayBuffer","options","parseToImageBitmap","loadImage","url","Image","response","fetch","loadToHTMLImage","createImageBitmap","Error","blob","Blob","Uint8Array","src","test","xml","text","btoa","Promise","resolve","reject","image","onload","onerror","err","crossOrigin","error"],"mappings":";AACA,SAAQA,cAAR,QAA6B,0BAA7B;AAEA,OAAO,MAAMC,aAAa,GAAGD,cAAc,IAAI,OAAOE,WAAP,KAAuB,WAA/D;AAGP,OAAO,SAASC,UAAT,CAAoBC,WAApB,EAAiCC,OAAjC,EAA0C;AAC/C,MAAIL,cAAJ,EAAoB;AAClB,WAAOA,cAAc,CAACI,WAAD,EAAcC,OAAd,CAArB;AACD;;AAED,SAAOC,kBAAkB,CAACF,WAAD,CAAzB;AACD;AAKD,gBAAsBG,SAAtB;AAAA;AAAA;;;iCAAO,WAAyBC,GAAzB,EAA8BH,OAA9B,EAAuC;AAC5C,QAAI,OAAOI,KAAP,KAAiB,WAArB,EAAkC;AAChC,YAAMC,QAAQ,SAASC,KAAK,CAACH,GAAD,EAAMH,OAAN,CAA5B;AACA,YAAMD,WAAW,SAASM,QAAQ,CAACN,WAAT,EAA1B;AACA,aAAOD,UAAU,CAACC,WAAD,CAAjB;AACD;;AACD,iBAAaQ,eAAe,CAACJ,GAAD,EAAMH,OAAN,CAA5B;AACD,G;;;;AAMD,OAAO,SAASC,kBAAT,CAA4BF,WAA5B,EAAyC;AAC9C,MAAI,OAAOS,iBAAP,KAA6B,WAAjC,EAA8C;AAC5C,UAAM,IAAIC,KAAJ,CAAU,YAAV,CAAN;AACD;;AAED,QAAMC,IAAI,GAAG,IAAIC,IAAJ,CAAS,CAAC,IAAIC,UAAJ,CAAeb,WAAf,CAAD,CAAT,CAAb;AACA,SAAOS,iBAAiB,CAACE,IAAD,CAAxB;AACD;AAGD,gBAAsBH,eAAtB;AAAA;AAAA;;;uCAAO,WAA+BJ,GAA/B,EAAoCH,OAApC,EAA6C;AAClD,QAAIa,GAAJ;;AACA,QAAI,oBAAoBC,IAApB,CAAyBX,GAAzB,CAAJ,EAAmC;AAEjC,YAAME,QAAQ,SAASC,KAAK,CAACH,GAAD,EAAMH,OAAN,CAA5B;AACA,YAAMe,GAAG,SAASV,QAAQ,CAACW,IAAT,EAAlB;AAEAH,MAAAA,GAAG,uCAAgCI,IAAI,CAACF,GAAD,CAApC,CAAH;AACD,KAND,MAMO;AACLF,MAAAA,GAAG,SAASV,GAAZ;AACD;;AAED,iBAAa,IAAIe,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC5C,UAAI;AACF,cAAMC,KAAK,GAAG,IAAIjB,KAAJ,EAAd;;AACAiB,QAAAA,KAAK,CAACC,MAAN,GAAe,MAAMH,OAAO,CAACE,KAAD,CAA5B;;AACAA,QAAAA,KAAK,CAACE,OAAN,GAAgBC,GAAG,IAAIJ,MAAM,CAAC,IAAIX,KAAJ,gCAAkCN,GAAlC,eAA0CqB,GAA1C,EAAD,CAA7B;;AACAH,QAAAA,KAAK,CAACI,WAAN,GAAqBzB,OAAO,IAAIA,OAAO,CAACyB,WAApB,IAAoC,WAAxD;AACAJ,QAAAA,KAAK,CAACR,GAAN,GAAYA,GAAZ;AACD,OAND,CAME,OAAOa,KAAP,EAAc;AACdN,QAAAA,MAAM,CAACM,KAAD,CAAN;AACD;AACF,KAVY,CAAb;AAWD,G","sourcesContent":["/* global Image, Blob, createImageBitmap, btoa, fetch */\nimport {parseImageNode} from '../node/parse-image-node';\n\nexport const canParseImage = parseImageNode || typeof ImageBitmap !== 'undefined';\n\n// Parse to platform defined type (ndarray on node, ImageBitmap on browser)\nexport function parseImage(arrayBuffer, options) {\n  if (parseImageNode) {\n    return parseImageNode(arrayBuffer, options);\n  }\n\n  return parseToImageBitmap(arrayBuffer);\n}\n\n// Fallback for older browsers\n// TODO - investigate Image.decode()\n// https://medium.com/dailyjs/image-loading-with-image-decode-b03652e7d2d2\nexport async function loadImage(url, options) {\n  if (typeof Image === 'undefined') {\n    const response = await fetch(url, options);\n    const arrayBuffer = await response.arrayBuffer();\n    return parseImage(arrayBuffer);\n  }\n  return await loadToHTMLImage(url, options);\n}\n\n// Asynchronously parses an array buffer into an ImageBitmap - this contains the decoded data\n// Supported on worker threads\n// Not supported on Edge and Safari\n// https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap#Browser_compatibility\nexport function parseToImageBitmap(arrayBuffer) {\n  if (typeof createImageBitmap === 'undefined') {\n    throw new Error('parseImage');\n  }\n\n  const blob = new Blob([new Uint8Array(arrayBuffer)]);\n  return createImageBitmap(blob);\n}\n\n//\nexport async function loadToHTMLImage(url, options) {\n  let src;\n  if (/\\.svg((\\?|#).*)?$/.test(url)) {\n    // is SVG\n    const response = await fetch(url, options);\n    const xml = await response.text();\n    // base64 encoding is safer. utf-8 fails in some browsers\n    src = `data:image/svg+xml;base64,${btoa(xml)}`;\n  } else {\n    src = await url;\n  }\n\n  return await new Promise((resolve, reject) => {\n    try {\n      const image = new Image();\n      image.onload = () => resolve(image);\n      image.onerror = err => reject(new Error(`Could not load image ${url}: ${err}`));\n      image.crossOrigin = (options && options.crossOrigin) || 'anonymous';\n      image.src = src;\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n"],"file":"parse-image.js"}